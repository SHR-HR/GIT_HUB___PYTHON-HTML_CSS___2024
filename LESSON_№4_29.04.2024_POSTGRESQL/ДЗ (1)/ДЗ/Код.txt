import psycopg2


with psycopg2.connect(
    dbname="lesson_third",
    user="postgres",
    password="admin",
    host="localhost",
    port="5432",
) as connect:
    # Создать таблицу
    with connect.cursor() as cur:
        cur.execute(
            """
                    CREATE TABLE IF NOT EXISTS users 
                    (
                        user_id SERIAL PRIMARY KEY,
                        username VARCHAR(100) UNIQUE NOT NULL,
                        password VARCHAR(100)
                    )
                    """
        )
        connect.commit()

    # Добавить юзера
    with connect.cursor() as cur:
        user_name = input("Введите логин: ")
        user_password = input("Введите пароль: ")
        try:
            cur.execute(
                f"""
                INSERT INTO users (username, password) VALUES 
                ('{user_name}', '{user_password}')
                        """
            )
            connect.commit()
        except psycopg2.errors.UniqueViolation as error:
            print("Пользователь с таким никнеймом уже существует!")
        finally:
            connect.rollback()

    # Получить всех юзеров
    with connect.cursor() as cur:
        cur.execute("SELECT * FROM users")
        users = cur.fetchall()
        for user in users:
            print(f"Name {user[1]}, password {len(user[2])}")

    # Авторизация
    with connect.cursor() as cur:
        for _ in range(3):
            login = input("Введите ваш логин: ")
            password = input("Введите ваш пароль: ")
            cur.execute(
                f"""
                        SELECT username, password FROM users
                        WHERE username = '{login}' AND password = '{password}'
                """
            )
            user = cur.fetchone()
            if not user:
                print("Не верные данные!")
                continue

            print("Вы вошли в систему!")
            break
